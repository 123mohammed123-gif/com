<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ØªØ­ÙˆÙŠÙ„ÙŠ - Ø£Ø¯Ø§Ø© ØªØ­ÙˆÙŠÙ„ Ø´Ø§Ù…Ù„Ø©</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap RTL CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet" />
  <style>
    body {
      background: #ffebeb;
      color: #8b0000;
      padding: 2rem;
      min-height: 100vh;
      transition: background 0.3s, color 0.3s;
    }
    .dark-mode {
      background: #121212 !important;
      color: #f55 !important;
    }
    .btn-toggle {
      position: fixed;
      top: 1rem;
      left: 1rem;
      z-index: 9999;
    }
    .output-link {
      font-weight: 600;
      color: #28a745;
      word-break: break-all;
      display: block;
      margin-top: 10px;
    }
    /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… */
    .progress {
      height: 25px;
    }
    .progress-bar {
      font-weight: bold;
      line-height: 25px;
      color: #fff;
    }
  </style>
</head>
<body>
  <button class="btn btn-danger btn-toggle" id="toggleTheme">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†</button>

  <div class="container bg-white rounded shadow p-4">
    <h1 class="text-center mb-4">ğŸ”„ ØªØ­ÙˆÙŠÙ„ÙŠ - Ø£Ø¯Ø§Ø© ØªØ­ÙˆÙŠÙ„ Ø´Ø§Ù…Ù„Ø©</h1>

    <div class="mb-3">
      <label for="conversionSelect" class="form-label">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªØ­ÙˆÙŠÙ„:</label>
      <select id="conversionSelect" class="form-select">
        <option value="compress">ğŸ“¦ Ø¶ØºØ· ØµÙˆØ±Ø©</option>
        <option value="img2pdf">ğŸ–¼ï¸ ØµÙˆØ±Ø© Ø¥Ù„Ù‰ PDF</option>
        <option value="mergepdf">ğŸ“‘ Ø¯Ù…Ø¬ PDF</option>
        <option value="html2word">ğŸ“„ HTML Ø¥Ù„Ù‰ Word</option>
        <option value="mp4toflv">ğŸ¬ ÙÙŠØ¯ÙŠÙˆ MP4 Ø¥Ù„Ù‰ FLV</option>
      </select>
    </div>

    <div class="mb-3">
      <label for="fileInput" class="form-label">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù„Ù Ø£Ùˆ Ø§Ù„Ù…Ù„ÙØ§Øª:</label>
      <input
        type="file"
        id="fileInput"
        class="form-control"
        multiple
        accept=".jpg,.jpeg,.png,.pdf,.html,.htm,.mp4"
      />
    </div>

    <div class="mb-3" id="htmlTextAreaContainer" style="display:none;">
      <label for="htmlInput" class="form-label">Ø£Ø¯Ø®Ù„ Ø§Ù„Ù†Øµ Ø£Ùˆ HTML:</label>
      <textarea id="htmlInput" class="form-control" rows="5"></textarea>
    </div>

    <button id="convertBtn" class="btn btn-danger w-100">ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ­ÙˆÙŠÙ„</button>

    <div id="output" class="mt-4"></div>
  </div>

  <!-- Ù…ÙƒØªØ¨Ø§Øª -->
  <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
  <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.9/dist/ffmpeg.min.js"></script>

  <script>
    const toggleThemeBtn = document.getElementById("toggleTheme");
    const body = document.body;
    toggleThemeBtn.addEventListener("click", () => {
      body.classList.toggle("dark-mode");
      toggleThemeBtn.textContent = body.classList.contains("dark-mode")
        ? "Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¶ÙŠØ¡"
        : "Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†";
    });

    const conversionSelect = document.getElementById("conversionSelect");
    const htmlTextAreaContainer = document.getElementById("htmlTextAreaContainer");
    const htmlInput = document.getElementById("htmlInput");
    const fileInput = document.getElementById("fileInput");
    const convertBtn = document.getElementById("convertBtn");
    const outputDiv = document.getElementById("output");

    // ffmpeg.wasm
    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({ log: true });

    conversionSelect.addEventListener("change", () => {
      if (conversionSelect.value === "html2word") {
        htmlTextAreaContainer.style.display = "block";
      } else {
        htmlTextAreaContainer.style.display = "none";
        htmlInput.value = "";
      }
      outputDiv.innerHTML = "";
      fileInput.value = "";
      convertBtn.disabled = false;
      convertBtn.textContent = "ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ­ÙˆÙŠÙ„";
    });

    async function compressImage(file) {
      const options = { maxSizeMB: 1, maxWidthOrHeight: 1024, useWebWorker: true };
      return await imageCompression(file, options);
    }

    async function imageToPDF(file) {
      const reader = new FileReader();
      return new Promise((resolve, reject) => {
        reader.onload = function (e) {
          const img = new Image();
          img.src = e.target.result;
          img.onload = () => {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            const imgWidth = 180;
            const imgHeight = (img.height * imgWidth) / img.width;
            pdf.addImage(img, "JPEG", 10, 10, imgWidth, imgHeight);
            const pdfBlob = pdf.output("blob");
            resolve(pdfBlob);
          };
          img.onerror = () => reject("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©");
        };
        reader.readAsDataURL(file);
      });
    }

    async function mergePDFs(files) {
      const mergedPdf = await PDFLib.PDFDocument.create();
      for (const file of files) {
        const bytes = await file.arrayBuffer();
        const pdf = await PDFLib.PDFDocument.load(bytes);
        const copiedPages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
        copiedPages.forEach((page) => mergedPdf.addPage(page));
      }
      const mergedBytes = await mergedPdf.save();
      return new Blob([mergedBytes], { type: "application/pdf" });
    }

    function htmlToWord(html) {
      return htmlDocx.asBlob(html);
    }

    let selectedFileForVideo;

    fileInput.addEventListener("change", () => {
      if (conversionSelect.value === "mp4toflv" && fileInput.files.length > 0) {
        selectedFileForVideo = fileInput.files[0];
      } else {
        selectedFileForVideo = null;
      }
    });

    convertBtn.addEventListener("click", async () => {
      outputDiv.innerHTML = "";
      const tool = conversionSelect.value;
      const files = fileInput.files;

      try {
        if (tool === "compress") {
          if (!files[0]) return alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©.");
          const compressed = await compressImage(files[0]);
          const url = URL.createObjectURL(compressed);
          const link = document.createElement("a");
          link.href = url;
          link.download = "compressed.jpg";
          link.textContent = "ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¶ØºÙˆØ·Ø©";
          link.className = "output-link";
          outputDiv.appendChild(link);

        } else if (tool === "img2pdf") {
          if (!files[0]) return alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©.");
          const pdfBlob = await imageToPDF(files[0]);
          const url = URL.createObjectURL(pdfBlob);
          const link = document.createElement("a");
          link.href = url;
          link.download = "converted.pdf";
          link.textContent = "ğŸ“¥ ØªØ­Ù…ÙŠÙ„ PDF Ù…Ù† Ø§Ù„ØµÙˆØ±Ø©";
          link.className = "output-link";
          outputDiv.appendChild(link);

        } else if (tool === "mergepdf") {
          if (!files.length) return alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„ÙØ§Øª PDF.");
          const pdfBlob = await mergePDFs(files);
          const url = URL.createObjectURL(pdfBlob);
          const link = document.createElement("a");
          link.href = url;
          link.download = "merged.pdf";
          link.textContent = "ğŸ“¥ ØªØ­Ù…ÙŠÙ„ PDF Ø§Ù„Ù…Ø¯Ù…Ø¬";
          link.className = "output-link";
          outputDiv.appendChild(link);

        } else if (tool === "html2word") {
          const html = htmlInput.value.trim();
          if (!html) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù†Øµ Ø£Ùˆ HTML.");
          const wordBlob = htmlToWord(html);
          const url = URL.createObjectURL(wordBlob);
          const link = document.createElement("a");
          link.href = url;
          link.download = "document.docx";
          link.textContent = "ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Word";
          link.className = "output-link";
          outputDiv.appendChild(link);

        } else if (tool === "mp4toflv") {
          if (!selectedFileForVideo) return alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù ÙÙŠØ¯ÙŠÙˆ MP4.");
          convertBtn.disabled = true;
          convertBtn.textContent = "â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ffmpeg... ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±";
          outputDiv.innerHTML = '';

          // Ø¥Ù†Ø´Ø§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
          const progressBar = document.createElement('div');
          progressBar.className = 'progress mt-3';
          progressBar.innerHTML = `
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">0%</div>
          `;
          outputDiv.appendChild(progressBar);
          const progressBarInner = progressBar.querySelector('.progress-bar');

          if (!ffmpeg.isLoaded()) {
            await ffmpeg.load();
          }

          convertBtn.textContent = "â³ Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ...";

          // ØªØ¹Ù‚Ø¨ Ø§Ù„ØªÙ‚Ø¯Ù…
          ffmpeg.setProgress(({ ratio }) => {
            let percent = Math.min(100, Math.floor(ratio * 100));
            progressBarInner.style.width = percent + '%';
            progressBarInner.textContent = percent + '%';
          });

          try {
            try { ffmpeg.FS("unlink", "input.mp4"); } catch {}
            try { ffmpeg.FS("unlink", "output.flv"); } catch {}

            ffmpeg.FS("writeFile", "input.mp4", await fetchFile(selectedFileForVideo));

            await ffmpeg.run("-i", "input.mp4", "-c:v", "flv", "output.flv");

            ffmpeg.setProgress(() => {});

            const data = ffmpeg.FS("readFile", "output.flv");

            const videoBlob = new Blob([data.buffer], { type: "video/x-flv" });
            const url = URL.createObjectURL(videoBlob);
            const link = document.createElement("a");
            link.href = url;
            link.download = "converted.flv";
            link.textContent = "â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù FLV";
            link.className = "output-link";
            outputDiv.appendChild(link);

          } catch (err) {
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ: " + err.message);
          } finally {
            convertBtn.disabled = false;
            convertBtn.textContent = "ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ­ÙˆÙŠÙ„";
          }
        }
      } catch (error) {
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£: " + error.message || error);
        convertBtn.disabled = false;
        convertBtn.textContent = "ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ­ÙˆÙŠÙ„";
      }
    });
  </script>
</body>
</html>
